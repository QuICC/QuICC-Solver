ARG BASEIMAGE
FROM $BASEIMAGE

COPY . /QuICC.src

RUN mkdir -p /QuICC.src/build \
  && cd /QuICC.src/build \
  && cmake .. -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_MESSAGE_LOG_LEVEL=VERBOSE \
    -DCMAKE_CUDA_COMPILER=nvcc \
    -DQUICC_USE_VKFFT=ON \
    -DQUICC_USE_PFSOLVE=ON \
    -DQUICC_USE_CUFFT=ON \
    -DQUICC_USE_KOKKOS=ON \
    -DQUICC_USE_KOKKOS_CUDA=ON \
    -DMLIR_DIR=/lib/llvm-17/lib/cmake/mlir \
    -DQUICC_EIGEN_ENABLE_VECTORIZATION=ON \
    -DQUICC_PROFILE_LEVEL=4 \
    -DQUICC_PROFILE_BACKEND=native \
    -DQUICC_PROFILE_NATIVE_SAMPLE=500 \
    -DQUICC_TESTSUITE_TYPES=ON \
    -DQUICC_TESTSUITE_MEMORY=ON \
    -DQUICC_TESTSUITE_VIEW=ON \
    -DQUICC_TESTSUITE_VIEWOPS=ON \
    -DQUICC_TESTSUITE_POLYNOMIAL=ON \
    -DQUICC_TESTSUITE_SPARSESM=ON \
    -DQUICC_TESTSUITE_TRANSFORM=ON \
    -DQUICC_TESTSUITE_PROFILING=ON \
    -DQUICC_TESTSUITE_FRAMEWORK=ON \
    -DQUICC_TESTSUITE_GRAPH=ON \
    -DQUICC_TESTSUITE_PYQUICC=ON \
  && make -j $(grep processor /proc/cpuinfo | wc -l)

